generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  name               String?
  passwordHash       String
  role               String              @default("SELLER")
  sellerId           String?
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  auditLogs          AuditLog[]
  inventoryLogs      InventoryMovement[]
  confirmedTopups    TopupRequest[]      @relation("ConfirmedBy")
  seller             Seller?             @relation(fields: [sellerId], references: [id])
  verificationTokens VerificationToken[]
  assignedJobs       Job[]               @relation("JobStaff")
  Ticket             Ticket[]
}

model VerificationToken {
  id         String   @id @default(uuid())
  identifier String
  token      String
  expires    DateTime
  createdAt  DateTime @default(now())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])

  @@unique([identifier, token])
}

model Seller {
  id            String         @id @default(uuid())
  code          String         @unique
  name          String
  contactEmail  String?
  phone         String?
  address       String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  jobs          Job[]
  orders        Order[]
  topupRequests TopupRequest[]
  users         User[]
  wallet        Wallet?
  walletLedger  WalletLedger[]
}

model Wallet {
  id        String   @id @default(uuid())
  sellerId  String   @unique
  balance   Float    @default(0.0)
  currency  String   @default("USD")
  updatedAt DateTime @updatedAt
  seller    Seller   @relation(fields: [sellerId], references: [id])
}

model WalletLedger {
  id        String   @id @default(uuid())
  sellerId  String
  type      String
  amount    Float
  currency  String   @default("USD")
  refType   String
  refId     String?
  note      String?
  createdBy String?
  createdAt DateTime @default(now())
  seller    Seller   @relation(fields: [sellerId], references: [id])

  @@index([sellerId])
  @@index([refType, refId])
  @@index([createdAt])
}

model TopupRequest {
  id              String    @id @default(uuid())
  sellerId        String
  amount          Float
  currency        String    @default("VND")
  bankName        String?
  bankAccount     String?
  transferContent String?
  status          String
  evidenceUrl     String?
  confirmedById   String?
  confirmedAt     DateTime?
  createdAt       DateTime  @default(now())
  confirmedBy     User?     @relation("ConfirmedBy", fields: [confirmedById], references: [id])
  seller          Seller    @relation(fields: [sellerId], references: [id])
}

model Product {
  id            String           @id @default(uuid())
  sku           String           @unique
  name          String
  isActive      Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  extraFees     String?
  shippingRates String?
  description   String?
  images        String           @default("[]") // Deprecated: Use ProductImage relation
  variants      ProductVariant[]
  productImages ProductImage[]
}

model ProductImage {
  id        String   @id @default(uuid())
  productId String
  url       String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductVariant {
  id           String   @id @default(uuid())
  productId    String
  color        String?
  size         String?
  basePrice    Float
  cogsEstimate Float?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  product      Product  @relation(fields: [productId], references: [id])

  @@unique([productId, color, size])
}

model InventoryItem {
  id        String   @id @default(uuid())
  sku       String
  color     String?
  size      String?
  onHand    Int      @default(0)
  reserved  Int      @default(0)
  minStock  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sku, color, size])
}

model InventoryMovement {
  id          String   @id @default(uuid())
  sku         String
  color       String?
  size        String?
  qtyChange   Int
  type        String
  refType     String?
  refId       String?
  createdById String?
  createdAt   DateTime @default(now())
  createdBy   User?    @relation(fields: [createdById], references: [id])
}

model Order {
  id              String     @id @default(uuid())
  sellerId        String
  orderCode       String     @unique
  status          String     @default("PENDING_APPROVAL")
  totalAmount     Float
  currency        String     @default("USD")
  shippingCountry String?
  shippingMethod  String?
  trackingNumber  String?
  carrier         String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  jobs            Job[]
  seller          Seller     @relation(fields: [sellerId], references: [id])
  shipments       Shipment[]
  Ticket          Ticket[]
  rejectionReason String?
}

model Job {
  id                  String    @id @default(uuid())
  orderId             String
  sellerId            String
  jobCode             String    @unique
  status              String    @default("PENDING_APPROVAL")
  sku                 String
  color               String?
  size                String?
  qty                 Int       @default(1)
  recipientName       String?
  phone               String?
  address1            String?
  address2            String?
  city                String?
  state               String?
  zip                 String?
  country             String?
  designs             String    @default("[]")
  fileLocalPath       String?
  fileStatus          String    @default("PENDING")
  embroideryDriveLink String?
  priceToCharge       Float
  cogsActual          Float?
  notes               String?
  assignedStaffId     String?
  assignedStaff       User?     @relation("JobStaff", fields: [assignedStaffId], references: [id])
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  seller              Seller    @relation(fields: [sellerId], references: [id])
  order               Order     @relation(fields: [orderId], references: [id])
  tokens              QrToken[]

  @@index([sellerId])
  @@index([status])
  @@index([assignedStaffId])
}

model QrToken {
  id        String    @id @default(uuid())
  jobId     String
  type      String
  token     String    @unique
  maxUses   Int?
  usedCount Int       @default(0)
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  job       Job       @relation(fields: [jobId], references: [id])
}

model Shipment {
  id             String   @id @default(uuid())
  orderId        String
  carrier        String?
  trackingNumber String?
  labelPdfUrl    String?
  status         String
  createdAt      DateTime @default(now())
  order          Order    @relation(fields: [orderId], references: [id])
}

model AuditLog {
  id          String   @id @default(uuid())
  actorUserId String?
  actorType   String
  action      String
  entityType  String
  entityId    String?
  metaJson    String?
  createdAt   DateTime @default(now())
  actorUser   User?    @relation(fields: [actorUserId], references: [id])
}

model Ticket {
  id          String   @id @default(uuid())
  userId      String
  orderId     String?
  subject     String?
  description String? // Initial description, kept for reference
  imageUrl    String?
  status      String   @default("PENDING") // PENDING, RESOLVED, REJECTED
  resolutionType String? // REFUND, REPLACEMENT, REJECT, NONE
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User            @relation(fields: [userId], references: [id])
  order    Order?          @relation(fields: [orderId], references: [id])
  messages TicketMessage[]

  @@index([userId])
  @@index([status])
}

model TicketMessage {
  id        String   @id @default(uuid())
  ticketId  String
  senderId  String
  senderRole String // USER or ADMIN
  message   String
  imageUrl  String? // Legacy, prefer attachments
  createdAt DateTime @default(now())

  ticket      Ticket             @relation(fields: [ticketId], references: [id])
  attachments TicketAttachment[]

  @@index([ticketId])
}

model TicketAttachment {
    id        String   @id @default(uuid())
    messageId String
    url       String
    type      String   @default("image") // image, video, file
    
    message   TicketMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
    
    @@index([messageId])
}
